class axi_monitor extends uvm_component;
  `uvm_component_utils(axi_monitor)

  virtual axi_if vif;
  uvm_analysis_port #(axi_item) ap;

  bit        aw_got, w_got, ar_got;
  bit [31:0] awaddr_q, wdata_q, araddr_q;
  bit [3:0]  wstrb_q;

  function new(string name, uvm_component parent);
    super.new(name, parent);
    ap = new("ap", this);
  endfunction

  function void build_phase(uvm_phase phase);
    super.build_phase(phase);
    if (!uvm_config_db#(virtual axi_if)::get(this, "", "vif", vif))
      `uvm_fatal("NOVIF", "axi_monitor: vif not set")
  endfunction

  task run_phase(uvm_phase phase);
    aw_got = 0;
    w_got  = 0;
    ar_got = 0;

    forever begin
      @(vif.mon_cb);

      if (!vif.rst_n) begin
        aw_got = 0;
        w_got  = 0;
        ar_got = 0;
        continue;
      end

      // -------------------------
      // WRITE channel collection
      // -------------------------
      if (vif.mon_cb.awvalid && vif.mon_cb.awready) begin
        aw_got   = 1;
        awaddr_q = vif.mon_cb.awaddr;
      end

      if (vif.mon_cb.wvalid && vif.mon_cb.wready) begin
        w_got   = 1;
        wdata_q = vif.mon_cb.wdata;
        wstrb_q = vif.mon_cb.wstrb;
      end

      // When B handshake happens, publish a WRITE transaction
      if (vif.mon_cb.bvalid && vif.mon_cb.bready) begin
        axi_item tr = axi_item::type_id::create("mon_wr");
        tr.kind  = WRITE;
        tr.addr  = awaddr_q;
        tr.wdata = wdata_q;
        tr.wstrb = wstrb_q;
        tr.resp  = vif.mon_cb.bresp;
        ap.write(tr);

        aw_got = 0;
        w_got  = 0;
      end

      // -------------------------
      // READ channel collection
      // -------------------------
      if (vif.mon_cb.arvalid && vif.mon_cb.arready) begin
        ar_got   = 1;
        araddr_q = vif.mon_cb.araddr;
      end

      // When R handshake happens, publish a READ transaction
      if (vif.mon_cb.rvalid && vif.mon_cb.rready) begin
        axi_item tr = axi_item::type_id::create("mon_rd");
        tr.kind  = READ;
        tr.addr  = araddr_q;
        tr.rdata = vif.mon_cb.rdata;
        tr.resp  = vif.mon_cb.rresp;
        ap.write(tr);

        ar_got = 0;
      end
    end
  endtask

endclass

